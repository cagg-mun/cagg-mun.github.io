
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Power Cycle Torngat &#8212; CAGG Torngat Documentation  documentation</title>
    
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="To Do" href="todo.html" />
    <link rel="prev" title="Compute Node Updates" href="computenodes.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="todo.html" title="To Do"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="computenodes.html" title="Compute Node Updates"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CAGG Torngat Documentation  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">System Information</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="power-cycle-torngat">
<h1>Power Cycle Torngat<a class="headerlink" href="#power-cycle-torngat" title="Permalink to this headline">¶</a></h1>
<div class="section" id="shutdown">
<h2>Shutdown<a class="headerlink" href="#shutdown" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Login to glauce (as yourself) and sudo to root</p>
</li>
<li><p class="first">Setup the ansible environment, the easiest way might be to go through
the history (up-arrow) to find the commands</p>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">cd</span> <span class="pre">~/ansible;</span> <span class="pre">.</span> <span class="pre">hacking/env-setup;</span> <span class="pre">export</span></code>
<code class="docutils literal"><span class="pre">ANSIBLE_HOSTS=~/clusterhosts;</span> <span class="pre">export</span></code>
<code class="docutils literal"><span class="pre">ANSIBLE_HOST_KEY_CHECKING=False</span></code></p>
</div></blockquote>
</li>
<li><p class="first">Shutdown the compute nodes.</p>
<ol class="arabic">
<li><p class="first">To power the machines off elegantly run:</p>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">ansible</span> <span class="pre">'cn'</span> <span class="pre">-a</span> <span class="pre">poweroff</span></code>
This command will run in parallel so the command will return
quickly.</p>
</div></blockquote>
</li>
<li><p class="first"><strong>Wait 5 minutes for the systems actually power off</strong></p>
</li>
<li><p class="first">Run the command:</p>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">ansible</span> <span class="pre">'ilo'</span> <span class="pre">-m</span> <span class="pre">raw</span> <span class="pre">-a</span> <span class="pre">power</span></code>
<code class="docutils literal"><span class="pre">|grep</span> <span class="pre">-E</span> <span class="pre">'(localdomain|server</span> <span class="pre">power|On)'</span></code>
The command will simply show the power status for the nodes
using the management interface. The last word of the status
line should be “Off”. With any luck, any systems that are on,
will have the word “On” in green . Check for any nodes that
show power “On”, skip down below for instructions on powering
them off.</p>
</div></blockquote>
</li>
</ol>
</li>
<li><p class="first">Power off the head nodes.</p>
<ol class="arabic">
<li><p class="first">First power off the secondary head node, which is actually called
torngat. To do that use the command:</p>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">ansible</span> <span class="pre">'hn02*;'</span> <span class="pre">-m</span> <span class="pre">raw</span> <span class="pre">-a</span> <span class="pre">poweroff</span></code></p>
</div></blockquote>
</li>
<li><p class="first"><strong>*Wait 5 minutes for the system to power off*</strong></p>
</li>
<li><p class="first">Run the command:</p>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">ansible</span> <span class="pre">'mphn02*;'</span> <span class="pre">-m</span> <span class="pre">raw</span> <span class="pre">-a</span> <span class="pre">power</span></code>
The command should return that the server power is off. If not
wait another 5 minutes and check again. If the system is still
not off, use the instructions for forcing power off on a
compute node.</p>
</div></blockquote>
</li>
<li><p class="first">Now power off the primary head node, avalon. Use the command:</p>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">ansible</span> <span class="pre">'hn01*;'</span> <span class="pre">-m</span> <span class="pre">raw</span> <span class="pre">-a</span> <span class="pre">poweroff</span></code></p>
</div></blockquote>
</li>
<li><p class="first"><strong>*Wait 5 minutes for the system to power off*</strong></p>
</li>
<li><p class="first">Run the command:</p>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">ansible</span> <span class="pre">'mphn01*;'</span> <span class="pre">-m</span> <span class="pre">raw</span> <span class="pre">-a</span> <span class="pre">power</span></code>
The command should return that the server power is off. If not
wait another 5 minutes and check again. If the system is still
not off, use the instructions for forcing power off on a
compute node.</p>
</div></blockquote>
</li>
</ol>
</li>
<li><p class="first">Lastly glauce can be powered off (the system used from steps 1-4),
just run the command “poweroff”</p>
</li>
<li><p class="first">Power off the UPS, press the power switch on the front.</p>
</li>
<li><p class="first">Turn off the 8 PDU master switches. This action will shutdown the
network devices, compute node chassis and storage chassis.</p>
</li>
<li><p class="first">Finished</p>
</li>
</ol>
</div>
<div class="section" id="startup">
<h2>Startup<a class="headerlink" href="#startup" title="Permalink to this headline">¶</a></h2>
<p>The startup is essentially the reverse of shutdown, with more physical
presense needed.</p>
<ol class="arabic">
<li><p class="first">Power on the PDU devices (8 of them). The network, storage chassis
and compute node chassis will power up.</p>
</li>
<li><p class="first">Power on the UPS.</p>
</li>
<li><p class="first"><strong>Wait for 10 minutes for the switches and chassis to settle.</strong></p>
</li>
<li><p class="first">Power on glauce (don’t need to wait, continue on)</p>
</li>
<li><p class="first">Power on avalon, the storage management and primary head node.</p>
</li>
<li><p class="first"><strong>WAIT for the console in the datacentre to show the system login screen.</strong></p>
</li>
<li><p class="first">Power on torngat, there is no console for this, so …</p>
</li>
<li><p class="first"><strong>Wait 5 minutes</strong></p>
</li>
<li><p class="first">Log into glauce (it should be up by now) as yourself and sudo to
root.</p>
</li>
<li><p class="first">Setup the ansible environment as per step 2 of shutdown.</p>
</li>
<li><p class="first">Power on the compute nodes by running the command:</p>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">ansible</span> <span class="pre">'ilo'</span> <span class="pre">-m</span> <span class="pre">raw</span> <span class="pre">-a</span> <span class="pre">'power</span> <span class="pre">on'</span></code></p>
</div></blockquote>
</li>
<li><p class="first"><strong>Wait 10 minutes for the systems to settle</strong></p>
</li>
<li><p class="first">Now validate that the systems are accessible by running:</p>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">ansible</span> <span class="pre">'cn'</span> <span class="pre">-m</span> <span class="pre">ping</span></code>
This runs in parallel so the results may be out of order. Check
that each of the 42 nodes responds with a success and a pong. The
node name should show success, and the ping should have a
corresponding pong. For nodes that are not up, each one must be
dealt with individually, see troubleshooting</p>
</div></blockquote>
</li>
</ol>
<p>#. Craig Squires will check that the queuing is functioning correctly
#.</p>
<blockquote>
<div></div></blockquote>
<ol class="arabic">
<li></li>
</ol>
<p>Finished</p>
<p>For systems that auto power up</p>
<p>If a system starts up automatically, there are 2 choices.</p>
<ol class="arabic simple">
<li>Shut the system down before beginning startup procedures. The shut
down can be done with a long press of the power button, or the remote
management, as per shutdown steps (glauce would need to be on)</li>
<li>Proceed with the startup, and reset/reboot the node after all power
is up (dealing with troublesome nodes)</li>
</ol>
</div>
<div class="section" id="troublesome-nodes">
<h2>Troublesome nodes<a class="headerlink" href="#troublesome-nodes" title="Permalink to this headline">¶</a></h2>
<div class="section" id="forcefully-powering-down-a-node">
<h3>Forcefully powering down a node<a class="headerlink" href="#forcefully-powering-down-a-node" title="Permalink to this headline">¶</a></h3>
<p>If for some reason the operating system has hung, the nodes can still be
forcefully powered off. There are 2 ways to achieve this, with a
physical power switch, or using remote management.</p>
<div class="section" id="remote-management">
<h4>Remote Management<a class="headerlink" href="#remote-management" title="Permalink to this headline">¶</a></h4>
<p>This can be done with ansible or direct ssh.</p>
<ul>
<li><p class="first">Using ansible the command is</p>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">ansible</span></code> <code class="docutils literal"><span class="pre">'mpcn&lt;node</span></code> <code class="docutils literal"><span class="pre">num&gt;*;'</span></code> <code class="docutils literal"><span class="pre">-m</span></code> <code class="docutils literal"><span class="pre">raw</span></code> <code class="docutils literal"><span class="pre">-a</span></code>
<code class="docutils literal"><span class="pre">'power</span></code> <code class="docutils literal"><span class="pre">off</span></code> <code class="docutils literal"><span class="pre">hard'</span></code>
For example: <code class="docutils literal"><span class="pre">ansible</span></code> <code class="docutils literal"><span class="pre">'mpcn42*;'</span></code> <code class="docutils literal"><span class="pre">-m</span></code> <code class="docutils literal"><span class="pre">raw</span></code> <code class="docutils literal"><span class="pre">-a</span></code>
<code class="docutils literal"><span class="pre">'power</span></code> <code class="docutils literal"><span class="pre">off</span></code> <code class="docutils literal"><span class="pre">hard'</span></code></p>
</div></blockquote>
</li>
<li><p class="first">Using ssh, simply ssh to the node and run ‘power off hard’. For
example: <code class="docutils literal"><span class="pre">ssh</span></code> <code class="docutils literal"><span class="pre">admin&#64;mpcn42</span></code> <code class="docutils literal"><span class="pre">power</span></code> <code class="docutils literal"><span class="pre">off</span></code> <code class="docutils literal"><span class="pre">hard</span></code></p>
</li>
</ul>
</div>
<div class="section" id="physically">
<h4>Physically<a class="headerlink" href="#physically" title="Permalink to this headline">¶</a></h4>
<p>Locate the node that still has power by the light in front, and press
and hold the power button until the power is off.</p>
</div>
</div>
<div class="section" id="restoring-nodes-that-do-not-return-to-normal-operating-status">
<h3>Restoring nodes that do not return to normal operating status<a class="headerlink" href="#restoring-nodes-that-do-not-return-to-normal-operating-status" title="Permalink to this headline">¶</a></h3>
<p>Most of these operations will be done from a terminal on glauce, and the
ansible setup from [onenote:Cluster.one Shutdown Plan] should have been
run before beginning this.</p>
<ol class="arabic">
<li><p class="first">Check that the node is powered on:</p>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">ansible</span> <span class="pre">'mpcn&lt;##&gt;;'</span> <span class="pre">-m</span> <span class="pre">raw</span> <span class="pre">-a</span> <span class="pre">power</span></code></p>
</div></blockquote>
</li>
<li><p class="first">Check the node console for error messages:</p>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">ssh</span> <span class="pre">admin&#64;mpcn&lt;##&gt;</span></code></p>
</div></blockquote>
<ol class="arabic simple">
<li>Run the command “vsp” which will show a serial console</li>
<li>If there is no login prompt<ol class="arabic">
<li>Use the exit from the serial console, it should be on the
screen ( ESC+( )</li>
<li>Command: <code class="docutils literal"><span class="pre">power</span> <span class="pre">off</span> <span class="pre">hard</span></code></li>
<li>Wait for the node power to go off, 2-5 minutes.</li>
<li>Command: <code class="docutils literal"><span class="pre">power</span> <span class="pre">on</span></code></li>
<li>Immediately type <code class="docutils literal"><span class="pre">vsp</span></code> and wait for the BIOS and boot messages
to start scrolling by. This can take a while so be patient.</li>
</ol>
</li>
<li>Else there is a login prompt so:<ol class="arabic">
<li>Login to the node as root</li>
<li>Use the <code class="docutils literal"><span class="pre">reboot</span></code> command</li>
</ol>
</li>
</ol>
</li>
<li><p class="first">If the error condition can not be resolved, then notify the users
group that a node is out, I’ll repair it when I get back.</p>
</li>
</ol>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Power Cycle Torngat</a><ul>
<li><a class="reference internal" href="#shutdown">Shutdown</a></li>
<li><a class="reference internal" href="#startup">Startup</a></li>
<li><a class="reference internal" href="#troublesome-nodes">Troublesome nodes</a><ul>
<li><a class="reference internal" href="#forcefully-powering-down-a-node">Forcefully powering down a node</a><ul>
<li><a class="reference internal" href="#remote-management">Remote Management</a></li>
<li><a class="reference internal" href="#physically">Physically</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restoring-nodes-that-do-not-return-to-normal-operating-status">Restoring nodes that do not return to normal operating status</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="computenodes.html"
                        title="previous chapter">Compute Node Updates</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="todo.html"
                        title="next chapter">To Do</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/systeminfo/powercycle.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="todo.html" title="To Do"
             >next</a> |</li>
        <li class="right" >
          <a href="computenodes.html" title="Compute Node Updates"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CAGG Torngat Documentation  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >System Information</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Paul S.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.1.
    </div>
  </body>
</html>