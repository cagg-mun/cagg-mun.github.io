<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>… run unusual code on Torngat &#8212; CAGG Torngat Documentation  documentation</title>
    
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="System Information" href="../systeminfo/index.html" />
    <link rel="prev" title="… run E3d on Torngat" href="e3d/e3d.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          CAGG Torngat Documentation</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">How do I …</a></li>
<li class="toctree-l1"><a class="reference internal" href="../systeminfo/index.html">System Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes.html">Paul S - Notes</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">… run unusual code on Torngat</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#the-code">“The Code”</a></li>
<li><a class="reference internal" href="#how-to-run-it-on-torngat">How to run it on torngat</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="e3d/e3d.html" title="Previous Chapter: … run E3d on Torngat"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; … run E3d on Torngat</span>
    </a>
  </li>
  <li>
    <a href="../systeminfo/index.html" title="Next Chapter: System Information"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">System Information &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/howdoi/unusual.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="run-unusual-code-on-torngat">
<h1>… run unusual code on Torngat<a class="headerlink" href="#run-unusual-code-on-torngat" title="Permalink to this headline">¶</a></h1>
<p><em>Tomasz Danek</em></p>
<p><em>June 10, 2013</em></p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Running code utilizing “unusual” parallelisation can be tricky on
Torngat supercomputer. Of course the definition of unusual job vary but
in general it can be assumed that any hybrid process-thread code should
be consider as the one. Probably the most commonly used hybrid codes are
the combinations of MPI processes and OMP threads. This short tutorial
presents how to run this kind of code on Torngat.</p>
</div>
<div class="section" id="the-code">
<h2>“The Code”<a class="headerlink" href="#the-code" title="Permalink to this headline">¶</a></h2>
<p>Let us consider the very simple MPI/OMP code creating a matrix which
rows and columns represents process and thread number. Each filed of
matrix is a number with first digit/digits defined by process and last
digit defined by thread number. Please note that presented code does not
present the optimal solution of the problem.</p>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
 <span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
 <span class="cp">#include</span> <span class="cpf">&lt;mpi.h&gt;</span><span class="cp"></span>
 <span class="cp">#include</span> <span class="cpf">&lt;omp.h&gt;</span><span class="cp"></span>

 <span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
 <span class="p">{</span>
 <span class="kt">int</span> <span class="n">my_rank</span><span class="p">;</span>
 <span class="kt">int</span> <span class="n">p</span><span class="p">,</span><span class="n">n_thr</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x</span><span class="p">;</span>
 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">**</span><span class="n">message</span><span class="p">;</span>

 <span class="n">MPI_Status</span> <span class="n">status</span><span class="p">;</span>

 <span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
 <span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">my_rank</span><span class="p">);</span>
 <span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>

 <span class="cp">#pragma omp parallel</span>
 <span class="n">n_thr</span><span class="o">=</span><span class="n">omp_get_num_threads</span><span class="p">();</span>

 <span class="n">message</span><span class="o">=</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">**</span><span class="p">)</span> <span class="n">calloc</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">));</span>
 <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">p</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
         <span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">calloc</span> <span class="p">(</span><span class="n">n_thr</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">));</span>

 <span class="cp">#pragma omp parallel private(x)</span>
 <span class="p">{</span>
         <span class="n">x</span><span class="o">=</span><span class="n">omp_get_thread_num</span><span class="p">();</span>
         <span class="n">message</span><span class="p">[</span><span class="n">my_rank</span><span class="p">][</span><span class="n">x</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="o">+</span><span class="p">(</span><span class="n">my_rank</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="p">;</span>
 <span class="p">}</span>

 <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">p</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
 <span class="p">{</span>
         <span class="n">MPI_Bcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_thr</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
 <span class="p">}</span>

 <span class="k">if</span> <span class="p">(</span><span class="n">my_rank</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
 <span class="p">{</span>
         <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">p</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
         <span class="p">{</span>
                 <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">n_thr</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
                         <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;%d &quot;</span><span class="p">,</span><span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
                 <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
         <span class="p">}</span>
 <span class="p">}</span>

 <span class="n">MPI_Finalize</span><span class="p">();</span>
 <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
 <span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Presented code is very simple but let us focus its most important
parallel part. First of all MPI is initialized and then each process
recognize its number (my_rank) and size of the MPI_COMM_WORD
communicator (p). Then number of OMP threads (n_thr) is set. Please
note that by default this value is taken from OMP_NUM_THREAD system
variable. After memory allocation for matrix message the second parallel
section is stared and process dependent row of the matrix if filled with
proper number representing process (first digit) and thread number
(second digit). Then every process broadcast its row to all other
processes so when communication is finished all process have a copy of
the same matrix. Finally process number 0 sends matrix message to
standard error stream.</p>
<p>This code can be compiled using Intel MPI compiler mpiicc (please note
double i):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mpiicc -O3 -xHOST main.c -openmp
</pre></div>
</div>
</div>
<div class="section" id="how-to-run-it-on-torngat">
<h2>How to run it on torngat<a class="headerlink" href="#how-to-run-it-on-torngat" title="Permalink to this headline">¶</a></h2>
<p>Let us assume that we want run 30 MPI processes and that every process
should start two threads. In a usual real life situation number of
threads should be equal to number of available cores to secure optimal
code efficiency so in this example user should reserve 60 cores. In
current Torngat configuration each node has 12 cores so for this run 5
nodes should be reserved.</p>
<p>To start and interactive session and reserve sufficient resources we
can, for example, use command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>qrsh -cwd -V -q churich.q -pe impi <span class="m">60</span> bash
</pre></div>
</div>
<p>For the explanation of the flags see Torngat user manual.</p>
<p>Then we have to define our own machine file. We can do it using the
script presented bellow:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

MakeMachineFile<span class="o">()</span>
<span class="o">{</span>
  cat <span class="nv">$1</span> <span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> line<span class="p">;</span> <span class="k">do</span>
     <span class="nv">host</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$line</span><span class="p">|</span>cut -f1 -d<span class="s2">&quot; &quot;</span><span class="p">|</span>cut -f1 -d<span class="s2">&quot;.&quot;</span><span class="sb">`</span>
     <span class="nv">nprocs</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$line</span><span class="p">|</span>cut -f2 -d<span class="s2">&quot; &quot;</span><span class="sb">`</span>
     <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$host</span><span class="s2">:</span><span class="nv">$nprocs</span><span class="s2">&quot;</span>
     <span class="nv">np</span><span class="o">=</span><span class="sb">`</span>expr <span class="nv">$np</span> + <span class="nv">$nprocs</span><span class="sb">`</span>
  <span class="k">done</span>
<span class="o">}</span>

MakeMachineFile <span class="nv">$PE_HOSTFILE</span>
</pre></div>
</div>
<p>After script execution:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>machines &gt; mfile
</pre></div>
</div>
<p>file with something similar to this should be created:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>cn32:12
cn24:12
cn15:12
cn16:12
cn07:12
</pre></div>
</div>
<p>Because we do not want to run 60 processes but 30 with 2 threads number
12 should be changed for 6. If you want to run 15 processes using 4
threads you should put 3 after colon.</p>
<p>Now proper script for our run has to be created. Because behavior of -V
flag can be unpredictable in some SGE configuration it is usually safer
to define all used system variables in this script. The simplest
possible script looks like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">2</span>
./a.out
</pre></div>
</div>
<p>Please note that the first line of the script define the number of the
threads used by every process. If omitted most probably only 1 thread
will be used by every process.</p>
<p>When machine and script files are ready job can be stared using mpi job
starter:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span><span class="n">mpiexec</span><span class="o">.</span><span class="n">hydra</span> <span class="o">-</span><span class="n">machinefile</span><span class="o">=</span><span class="n">mfile</span> <span class="o">-</span><span class="n">np</span> <span class="mi">30</span> <span class="n">bash</span> <span class="n">script</span>
</pre></div>
</div>
<p>and the displayed output should be similar to:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>10 11
20 21
30 31
40 41
50 51
60 61
70 71
80 81
90 91
100 101
110 111
120 121
130 131
140 141
150 151
160 161
170 171
180 181
190 191
200 201
210 211
220 221
230 231
240 241
250 251
260 261
270 271
280 281
290 291
300 301
</pre></div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017, Paul S.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>